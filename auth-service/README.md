# Auth Service

Authentication microservice providing user registration, login, and JWT token management.

## Technology Stack

- Java 21
- Spring Boot 3.4.2
- Spring Security
- Spring Data JPA
- PostgreSQL 16
- JWT (jjwt 0.11.5)

## API Endpoints

| Method | Endpoint | Description |
|--------|----------|-------------|
| POST | /auth/login | Authenticate user and return JWT token with JTI claim |
| POST | /auth/register | Register new user account |
| POST | /auth/validate | Validate JWT token (checks signature and JTI blacklist) |
| POST | /auth/logout | Logout and blacklist token JTI |
| POST | /auth/refresh | Refresh access token using refresh token |

### Request/Response Examples

**Login**
```bash
curl -X POST http://localhost:8081/auth/login \
  -H "Content-Type: application/json" \
  -d '{"email": "admin@example.com", "password": "password123"}'
```

Response:
```json
{
  "token": "eyJhbGciOiJIUzI1NiJ9...",
  "email": "admin@example.com",
  "role": "ADMIN"
}
```

**Refresh Token**
```bash
curl -X POST http://localhost:8081/auth/refresh \
  -H "Content-Type: application/json" \
  -d '{"refreshToken": "eyJhbGciOiJIUzI1NiJ9..."}'
```

Response:
```json
{
  "token": "eyJhbGciOiJIUzI1NiJ9..."
}
```

**Logout**
```bash
curl -X POST http://localhost:8081/auth/logout \
  -H "Cookie: token=eyJhbGciOiJIUzI1NiJ9..."
```
```bash
curl -X POST http://localhost:8081/auth/register \
  -H "Content-Type: application/json" \
  -d '{"email": "user@example.com", "password": "password123"}'
```

## Build and Run

### With Docker (Recommended)

```bash
# From project root
docker-compose up --build auth-service auth-db
```

### Local Development

Requires PostgreSQL running on localhost:5432.

```bash
# Build
./mvnw clean package -DskipTests

# Run
./mvnw spring-boot:run

# Run without database (lazy mode)
LAZY_INIT=true DDL_AUTO=none ./mvnw spring-boot:run
```

### Run Tests

```bash
./mvnw test
```

## Configuration

### Environment Variables

| Variable | Default | Description |
|----------|---------|-------------|
| SERVER_PORT | 8081 | Server port |
| DB_HOST | localhost | Database host |
| DB_PORT | 5432 | Database port |
| DB_NAME | authdb | Database name |
| DB_USERNAME | postgres | Database username |
| DB_PASSWORD | password | Database password |
| JWT_SECRET | (default key) | JWT signing secret |
| JWT_EXPIRATION | 36000000 | Token expiration in ms (10 hours) |
| ADMIN_EMAIL | admin@example.com | Default admin email |
| ADMIN_PASSWORD | password123 | Default admin password |
| RATE_LIMIT_LOGIN | 5 | Max login attempts per window |
| RATE_LIMIT_LOGIN_WINDOW | 60 | Rate limit window in seconds |
| LAZY_INIT | false | Enable lazy initialization |
| DDL_AUTO | update | JPA schema generation mode |

## Project Structure

```
src/main/java/com/example/auth/
├── AuthApplication.java       # Application entry point
├── config/
│   ├── SecurityConfig.java    # Spring Security configuration
│   ├── RateLimitFilter.java   # Login rate limiting
│   └── AdminInitializer.java  # Creates admin on startup
├── controller/
│   └── AuthController.java    # REST endpoints
├── dto/
│   ├── LoginRequest.java
│   ├── RegisterRequest.java
│   └── AuthResponse.java
├── exception/
│   └── AuthException.java
├── model/
│   ├── User.java              # JPA entity
│   └── Role.java              # USER, ADMIN enum
├── repository/
│   └── UserRepository.java
├── security/
│   └── JwtUtil.java           # JWT generation and validation
├── service/
│   └── AuthService.java       # Business logic
└── validation/
    └── PasswordValidator.java
```

## Security Features

- **JWT with JTI Claims**: Every token includes a unique JWT ID (JTI) for secure token identification and revocation
- **BCrypt Password Hashing**: Passwords securely hashed using BCrypt
- **Token Blacklisting**: JTI-based blacklist on logout (36-byte UUID vs 500+ bytes full-token storage)
- **Refresh Token Management**: Long-lived refresh tokens (7 days) enable token refresh without re-authentication
- **Rate Limiting**: Login endpoint limited to 5 attempts per 60 seconds
- **Input Validation**: Email and password validation on registration
- **Server-Side Session Management**: Sessions tracked in Redis auth-cache

## Database Schema

The schema is auto-generated by JPA. Main table:

```sql
CREATE TABLE users (
    id BIGSERIAL PRIMARY KEY,
    email VARCHAR(255) NOT NULL UNIQUE,
    password VARCHAR(255) NOT NULL,
    role VARCHAR(50) NOT NULL DEFAULT 'USER',
    created_at TIMESTAMP NOT NULL,
    updated_at TIMESTAMP NOT NULL
);
```
